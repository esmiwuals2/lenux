#!/usr/bin/node
var cp = require('child_process');
var fs = require('fs');
var path = require('path');
var control = 'shell';
var cwd = process.cwd();
function listener(data) {
  if (control == 'shell') {
    var command = data.toString().split('\n')[0].split(' ');
    var prog = command[0];
    command.shift();
    if (prog == 'cd') {
      var pathToCheck = '';
      if (command[0].charAt(0) == '/') {
        pathToCheck = path.resolve(command[0]);
      }
      else {
        pathToCheck = path.resolve(path.join(cwd, command[0]));
      }
      fs.stat(pathToCheck, function(err, stats) {
        if (err) {
          console.log('No such file or directory!');
        }
        else {
          if (stats.isDirectory()) {
            cwd = pathToCheck;
          }
          else {
            console.log('Not a directory!');
          }
        }
        process.stdout.write('$ ');
      });
    }
    else if (prog == '') {
      process.stdout.write('$ ');
    }
    else if ((prog == 'exit') || (prog == 'logout')) {
      if (command[0] !== undefined) {
        process.exit(command[0]);
      }
      else {
        process.exit();
      }
    }
    else {
      var program = cp.spawn(prog, command, {env: process.env, cwd: cwd, stdio: 'inherit'});
      control = 'child';
      program.on('error', function(err) {
        process.stderr.write(err + '\n');
        process.stdout.write('$ ');
        control = 'shell';
       });
      program.on('exit', function(code) {
        process.stdout.write('$ ');
        control = 'shell';
      });
    }
  }
}
process.stdout.write('$ ');
process.stdin.on('data', listener);
